# how to add new visualization

If you were to add a new type of visualization, let say for a new data
structure. How would you do that. This document tells the different
places that would require change.



## BRIDGES client side

First, the bridges client (C++, Java, and Python) would need to be
modified to add a new kind of data structure. That data structure
needs to specify a new daastructure type. This is in the C++ client
defined by the `getDStype()` virtual functions, which goes in the
`visual` attribute of the main JSON sent to the server (defined in C++
in `getJSONHeader()`).

## server puts the assignment in the database

The function called server side that processes the upload of an
assignment is in `app/controllers/assignment.js`. it is the function
mapped to `exports.upload`.


This function sets a lot of the default values for the meta data of an
assignment if they are not specified by the client.

The server map the `visual` attribute in the JSON it received to a
visualization type `vistype` in `app/controllers/visType.js`. The
visualization type essentially indicate which format the underlying
datastructurre will be stored as and the way it will be rendered by
provided the name of the appropriate rendering script. This vistype is
what will eventually be used when displaying the assignment to figure
out what to do with it.

Some checks are performed server side for correctness in
`exports.upload` and the objects that is ultimately stored in mongo is
crafted by this function. The JSON crafted by the client is stored in
the mongo object in the `data` field. And other fields (like
`username` and `email`) are adeed in `saveAssignment()`. Note that
some of the default values of some fields are set in the constructor
of `Assignment` in `app/models/assignments.js` (for instance
`dateCreated`).


## giving the assignment to the webclient

The assignment data is returned to the client through two different
routes. The JSON that represents the assignment (after decoration by
the server) is returned by the function in
`app/controllers/assignments.js` mapped to `exports.getJSON`. It
simply returns whatever is in the database, provided the client has
the appropriate credentials.

The HTML that is rendered whenever we follow the link displayed by a
BRIDGES client is generated by the function in
`app/controllers/assignments.js` that is mapped to the `exports.get`
function. The HTML generated will come from a PUG file. Which PUG file
is used will depend on how many whether there is only a single
subassignment or multiple ones in that assignment. And whether the
disply of multiple subassignment with a list of iframes or a set of
tabs.

But all of these PUG files will need to be configured not only to
point to the right assignment data, but also to have loaded the
appropriate javascript codes based on `vistype`. This happens in the
`renderVis` function. So if the visualization need appropriate scripts
loaded early in the page, they would go in that `renderVis` function.

## rendering the assignment

The HTML that is generated by the server loads two critical javascript
files that will render the assignments. The first one is
`public/js/Bridges/BridgesVisualizer.js` and the second is
`public/js/multiVisconfig.js`. Note that generic JS files are loaded
as part of the boilerplate (like d3, highcharts, jquery).

The `BridgesVisualizer.js` file mostly contains generally applicable
helper functions that could be used by any of the particular types of
visualizations. They also do basic scaling and offset calculation to
make the rendering centered.

Most of the interactive components are defined in `multiVisconfig.js`.

Eventually the rendering of the assignment itsefl is done by the
`visualizeAssignment()` function. which will call the appropriate
visualization function based on the assignment vistype. Note that the
visualization function defined by bridges are added to the `d3`
object. (This does not seem wise, but that's what it is). Overall the
entire display of the assignments is managed by d3 at a level or an
other. Even though not all rendering are done using d3. (As they may
be delegate to webgl or other types of backend).

These different rendering function are properly available because they
have been loaded in `updateVis()` using the `addScript()`
function. And it knew which javascript to load because it had been
passed as a resource to load when teh PUG file was created out of the
`script` field returned by the `getVisTypeObject()` function in the
`app/controllers/visTypes.js` file.

The different functions for the different vistypes run somewhat
differently. But typically they take the width and height of the
object they render in. They take the DOM object they are supposed to
render in (often an SVG, but where appropriate a canvas). And the data
(or pieces of it) that was specified by the BRIDGES client when the
submission was originally made.